---
title: "Preprocessing"
author: "Charles J. Gomez, Harshvardhan Singh"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The country column in our dataset contains a more detailed information about the authors' affiliations, including first, middle, and last authors. However, this brings a level of complexity and potential confusion for machine learning models. Therefore, we propose a method to simplify the country column by retaining only the first and last author affiliations, ensuring a more straightforward representation of authorship.
```{r}
library(stringr)

data = read.csv("INPUT_SQL_Text_Data_Astronomy_and_Astrophysics.csv")
data_CountryColumn <- data$country

#We removed all instances of middle authors' country codes. This step involved replacing the pattern "\w+\+middle" with an empty string, effectively eliminating all middle author affiliations. The resulting country codes were then trimmed to remove any leading or trailing spaces

data$country <- gsub("\\w+\\+middle", "", data$country)
data$country <- trimws(data$country)
print(head(data$country, 50))

#We removed the "+first" and "+last" strings from the remaining country codes using another regular expression substitution. The pattern "\+last|\+first" was replaced with an empty string, ensuring that only the country codes remained

data$country <- gsub("\\+last|\\+first", "", data$country)
# Remove any extra spaces resulting from the removal
data$country <- sapply(strsplit(data$country, "\\s+"), function(x) paste(x[x != ""], collapse = " "))

print(head(data$country, 50))



# calculate the percentage count of each country code in a vector
#calculate_percentage <- function(vec) {
#  counts <- table(vec)
#  percentages <- prop.table(counts) * 100
#  formatted <- paste0(round(percentages, 1), "%", names(percentages))
#  paste(formatted, collapse = " ")
#}

# Apply the calculate_percentage function to each row in the 'country' column
#data$country <- sapply(strsplit(data$country, "\\s+"), calculate_percentage)

# Print the modified 'country' column (first 20)
#print(head(data$country, 50))




# Calculate percentage count of each country code in a vector
calculate_percentage <- function(vec) {
  counts <- table(vec)
  percentages <- prop.table(counts) * 100
  return(percentages)
}

# Apply the calculate_percentage function to each row in the 'country' column
percentage_counts <- lapply(strsplit(data$country, "\\s+"), calculate_percentage)

# Get all unique countries
all_countries <- unique(unlist(lapply(percentage_counts, names)))

# Initialize a new data frame to hold the percentages
percentage_df <- data.frame(matrix(ncol = length(all_countries), nrow = length(percentage_counts)))
names(percentage_df) <- all_countries

# Fill the data frame with percentages
for (i in seq_along(percentage_counts)) {
  country_names <- names(percentage_counts[[i]])
  country_percentages <- percentage_counts[[i]]
  percentage_df[i, country_names] <- country_percentages
}

# Replace NA values with 0
percentage_df[is.na(percentage_df)] <- 0

# Combine the original data with the new percentage-encoded country columns
data <- cbind(data, percentage_df)

# Summary of dataframe
summary(data)

# structure of the dataframe
str(data)


# Load the necessary libraries
library(ggplot2)
library(dplyr)

#Histogram by number of articles each country has contributed to

# Calculate count of each country code in a vector
calculate_count <- function(vec) {
  counts <- table(vec)
  return(counts)
}

# Apply the calculate_count function to each row in the 'country' column
counts <- lapply(strsplit(data$country, "\\s+"), calculate_count)

# Get all unique countries
all_countries <- unique(unlist(lapply(counts, names)))

# Initialize a new data frame to hold the counts
count_df <- data.frame(matrix(ncol = length(all_countries), nrow = length(counts)))
names(count_df) <- all_countries

# Fill the data frame with counts
for (i in seq_along(counts)) {
  country_names <- names(counts[[i]])
  country_counts <- counts[[i]]
  count_df[i, country_names] <- country_counts
}

# Replace NA values with 0
count_df[is.na(count_df)] <- 0

# Combine the original data with the new count-encoded country columns
data <- cbind(data, count_df)

# Combine all countries into one column for the histogram
all_countries_df <- stack(count_df)

# Rename the columns
colnames(all_countries_df) <- c("Count", "Country")

# Remove rows where count is zero
all_countries_df <- all_countries_df[all_countries_df$Count > 0,]

# Calculate the total counts for each country
all_countries_df <- all_countries_df %>%
  group_by(Country) %>%
  summarise(Total = sum(Count)) %>%
  arrange(desc(Total))

# Split the data frame into 5 equal parts
split_data <- split(all_countries_df, cut(seq(nrow(all_countries_df)), 5, labels = FALSE))

# Create a list to store the plots
plot_list <- list()

# Iterate over each subset of data and create a histogram with count
plot_list <- lapply(1:5, function(i) {
  ggplot(split_data[[i]], aes(x=reorder(Country, -Total), y=Total)) +
    geom_bar(stat="identity", fill="steelblue") +
    geom_text(aes(label=Total), vjust=-0.5, size=2.5) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x="Country", y="Number of Contributions", 
         title = paste("Research Publications by Country: Part", i))
})

# View each plot by calling it from the list
plot_list[[1]]
plot_list[[2]]
plot_list[[3]]
plot_list[[4]]
plot_list[[5]]


#Histogram of total research contributions by country


# Combine all countries into one column for the histogram
all_countries_df <- stack(percentage_df)

# Rename the columns
colnames(all_countries_df) <- c("Percentage", "Country")

# Remove rows where percentage is zero
all_countries_df <- all_countries_df[all_countries_df$Percentage > 0,]

# Calculate the total percentage for each country
all_countries_df <- all_countries_df %>%
  group_by(Country) %>%
  summarise(Total = sum(Percentage)) %>%
  arrange(desc(Total))

# Split the data frame into 5 equal parts
split_data <- split(all_countries_df, cut(seq(nrow(all_countries_df)), 5, labels = FALSE))

# Create a list to store the plots
plot_list <- list()

# Define the text size for each plot
text_size <- c(1.5, 2, 2, 2.5, 2.5)

# Iterate over each subset of data and create a histogram
plot_list <- lapply(1:5, function(i) {
  ggplot(split_data[[i]], aes(x=reorder(Country, -Total), y=Total)) +
    geom_bar(stat="identity", fill="purple") +
    geom_text(aes(label=sprintf("%.2f", Total)), vjust=-0.5, size=text_size[i]) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x="Country", y="Total Contribution Count", 
         title = paste("Total Research Contributions (total weight): Part", i))
})

# View each plot by calling it from the list
plot_list[[1]]
plot_list[[2]]
plot_list[[3]]
plot_list[[4]]
plot_list[[5]]


# Histogram of Research Contributions % by Country

# Calculate total of all percentages
total_percentage <- sum(all_countries_df$Total)

# Express each country's contribution as a percentage of total
all_countries_df <- all_countries_df %>%
  mutate(Percentage_of_Total = Total / total_percentage * 100) %>%
  arrange(desc(Percentage_of_Total))

# Split the data frame into 5 equal parts
split_data <- split(all_countries_df, cut(seq(nrow(all_countries_df)), 5, labels = FALSE))

# Create a list to store the plots
plot_list <- list()

# Define the decimal places for each plot
formats <- c("%.2f%%", "%.2f%%", "%.3f%%", "%.4f%%", "%.4f%%")

# Define the text size for each plot
text_size <- c(2.5, 2.5, 2, 2, 2)

# Iterate over each subset of data and create a histogram
plot_list <- lapply(1:5, function(i) {
  ggplot(split_data[[i]], aes(x=reorder(Country, -Percentage_of_Total), y=Percentage_of_Total)) +
    geom_bar(stat="identity", fill="orange") +
    geom_text(aes(label=sprintf(formats[i], Percentage_of_Total)), vjust=-0.5, size=text_size[i]) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x="Country", y="Total Contribution", 
         title = paste("Percentage Distribution of Global Research Contributions: Part", i))
})

# View each plot by calling it from the list
plot_list[[1]]
plot_list[[2]]
plot_list[[3]]
plot_list[[4]]
plot_list[[5]]




```
